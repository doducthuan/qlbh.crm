@{
    Layout = "_Admin_Layout";
}
<style>

    .timeline.timeline-border-dashed .timeline-icon {
        border-style: dashed !important;
    }

    .timeline .timeline-icon {
        z-index: 1;
        flex-shrink: 0;
        margin-right: 1rem;
        width: 38px;
        height: 38px;
        display: flex;
        text-align: center;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--bs-gray-300);
        border-radius: 50%;
    }

    .timeline {
        --bs-timeline-icon-size: 38px;
        --bs-timeline-icon-space: 0.35rem;
    }

        .timeline .timeline-line {
            display: block;
            content: " ";
            justify-content: center;
            position: absolute;
            z-index: 0;
            left: 0;
            top: 38px;
            bottom: 0;
            transform: translate(50%);
            border-left-width: 1px;
            border-left-style: dashed;
            border-left-color: var(--bs-gray-300);
            width: 38px;
            margin-top: 0.35rem;
            margin-bottom: 0.35rem;
        }

    .icon-info-pass {
        gap: 5px;
    }

    .column-stt, .column-date, .column-createdTime {
        text-align: center;
    }

    .column-kpi {
        text-align: right;
    }
</style>
<div id="kt_app_toolbar" class="app-toolbar  py-3 py-lg-6 ">
    <!--begin::Toolbar container-->
    <div id="kt_app_toolbar_container" class="app-container  container-fluid d-flex flex-stack ">
        <!--begin::Page title-->
        <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3 ">
            <!--begin::Title-->
            <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                Thông tin cá nhân
            </h1>
            <!--end::Title-->
            <!--begin::Breadcrumb-->
            <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                <!--begin::Item-->
                <li class="breadcrumb-item text-muted">
                    <a class="text-muted text-hover-primary" id="pageindex-name">
                        Trang chủ
                    </a>
                </li>
                <!--end::Item-->
                <!--begin::Item-->
                <li class="breadcrumb-item">
                    <span class="bullet bg-gray-400 w-5px h-2px"></span>
                </li>
                <!--end::Item-->
                <!--begin::Item-->
                <li class="breadcrumb-item text-muted" id="page-module">
                    Tài khoản
                </li>
                <li class="breadcrumb-item">
                    <span class="bullet bg-gray-400 w-5px h-2px"></span>
                </li>
                <!--end::Item-->
                <!--begin::Item-->
                <li class="breadcrumb-item text-muted" id="page-module">
                    Thông tin cá nhân
                </li>
                <!--end::Item-->

            </ul>
            <!--end::Breadcrumb-->
        </div>
    </div>
    <!--end::Toolbar container-->
</div>
<div id="kt_app_content" class="app-content flex-column-fluid">
    <div id="kt_app_content_container" class="app-container container-fluid">
        <div class="card mb-5 mb-xl-10">
            <div class="card-body pt-9 pb-0">
                <ul class="nav nav-stretch nav-line-tabs nav-line-tabs-2x border-transparent fs-5 fw-bold">
                    <li class="nav-item">
                        <a class="nav-link active" id="view-info" data-bs-toggle="tab" href="#kt_tab_pane_1">Chi tiết hồ sơ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="view-password" data-bs-toggle="tab" href="#kt_tab_pane_2">Thay đổi mật khẩu</a>
                    </li>
                </ul>

                <div class="tab-content" id="myTabContentProfile">
                    <div class="tab-pane fade show active" id="kt_tab_pane_1" role="tabpanel">

                        <div id="kt_account_settings_profile_details" class="collapse show">

                            <form id="form-info" class="form">
                                <div class="card-body border-top p-9">


                                    <div class="row mb-6">
                                        <label class="col-lg-2 col-form-label required fw-semibold fs-6">Họ và tên</label>
                                        <div class="col-lg-3">
                                            <input type="text" id="full-name" name="fname" class="form-control form-control-lg  mb-3 mb-lg-0" value="" />
                                        </div>
                                    </div>
                                    <div class="row mb-6">
                                        <label class="col-lg-2 col-form-label fw-semibold fs-6">Tên đăng nhập</label>
                                        <div class="col-lg-3 fv-row">
                                            <label type="text" id="user-name" name="company" class="form-control form-control-lg " value="" title="Không thể chỉnh sửa" style="background-color:#DCDCDC" />
                                        </div>
                                    </div>
                                    <div class="row mb-6">
                                        <label class="col-lg-2 col-form-label fw-semibold fs-6">
                                            <span>Vai trò</span>
                                        </label>
                                        <div class="col-lg-3 fv-row">
                                            <label type="tel" id="role-name" name="phone" class="form-control form-control-lg " value="" title="Không thể chỉnh sửa" style="background-color:#DCDCDC" />
                                        </div>
                                    </div>
                                </div>

                                <div class="card-footer d-flex justify-content-end py-6 px-9">
                                    <button type="button" class="btn btn-primary" id="update-info">
                                        <span class="indicator-label">
                                            Cập nhật
                                        </span>
                                        <span class="indicator-progress">
                                            Đang tải... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="tab-pane fade d-none" id="kt_tab_pane_2" role="tabpanel">
                        <div class="card mb-5 mb-xl-10">
                            <form id="form-pass" class="form">
                                <div class="card-body border-top p-9">
                                    <div class="row mb-6">
                                        <label for="currentpassword" class="col-lg-2 col-form-label required fw-semibold fs-6">Mật khẩu hiện tại</label>
                                        <div class="position-relative d-flex align-items-center input-group-pass mb-3 col-lg-3 fv-row">
                                            <span type="button" class="svg-icon svg-icon-1 fs-3 position-absolute me-5 end-0 btn_show_old_pass">
                                                <i class="ki-duotone ki-eye fs-3" id="icon-old-pass">
                                                    <span class="path1 ki-uniEC0B"></span>
                                                    <span class="path2 ki-uniEC0B"></span>
                                                    <span class="path3 ki-uniEC0D"></span>
                                                </i>
                                            </span>
                                            <input type="password" id="old-pass" class="form-control pe-3  mb-3 mb-lg-0">
                                        </div>
                                    </div>

                                    <div class="row mb-6">
                                        <label for="newpassword" class="col-lg-2 col-form-label required fw-semibold fs-6">Mật khẩu mới</label>
                                        <div class="position-relative d-flex align-items-center input-group-pass mb-3 col-lg-3 fv-row">
                                            <span type="button" class="svg-icon svg-icon-1 fs-3 position-absolute me-5 end-0 btn_show_new_pass">
                                                <i class="ki-duotone ki-eye fs-3" id="icon-new-pass">
                                                    <span class="path1 ki-uniEC0B"></span>
                                                    <span class="path2 ki-uniEC0B"></span>
                                                    <span class="path3 ki-uniEC0D"></span>
                                                </i>
                                            </span>
                                            <input type="password" id="new-pass" class="form-control pe-3  mb-3 mb-lg-0">
                                        </div>
                                    </div>
                                    <div class="row mb-6">
                                        <label for="confirmpassword" class="col-lg-2 col-form-label required fw-semibold fs-6">Nhập lại mật khẩu mới</label>
                                        <div class="position-relative d-flex align-items-center input-group-pass mb-3 col-lg-3 fv-row">
                                            <span type="button" class="svg-icon svg-icon-1 fs-3 position-absolute me-5 end-0 btn_show_confirm_pass">
                                                <i class="ki-duotone ki-eye fs-3" id="icon-confirm-pass">
                                                    <span class="path1 ki-uniEC0B"></span>
                                                    <span class="path2 ki-uniEC0B"></span>
                                                    <span class="path3 ki-uniEC0D"></span>
                                                </i>
                                            </span>
                                            <input type="password" id="confirm-pass" class="form-control pe-3  mb-3 mb-lg-0">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer d-flex justify-content-end py-6 px-9">
                                    <button type="button" class="btn btn-primary" id="update-pass">
                                        <span class="indicator-label">
                                            Cập nhật mật khẩu
                                        </span>
                                        <span class="indicator-progress">
                                            Đang tải... <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script>



    // khi sear all
    $('#search-history-kpi').on("keypress", function (e) {
        if (e.keyCode === 13) {
            accountKPIPaging.pageIndex = 1;
            loadHistoryKPIPaging();
        }
    });
    const VND = new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
    });
    var currentView = 0; // 0: màn info,   1 : màn change pass
    document.getElementById('update-info').addEventListener('click', function (e) {
        e.preventDefault();
        ValidateData();
    });
    document.getElementById('update-pass').addEventListener('click', function (e) {
        e.preventDefault();
        ValidateData();
    });
    $('.btn_show_old_pass').on('click', function (e) {
        if ($('#old-pass').attr('type') == 'text') {
            $('#old-pass').attr('type', 'password');
            $(this).html(`<i class="ki-duotone ki-eye fs-3" id="icon-old-pass">
                                                                                       <span class="path1 ki-uniEC0B"></span>
                                                                                       <span class="path2 ki-uniEC0B"></span>
                                                                                       <span class="path3 ki-uniEC0D"></span>
                                                                                  </i>`);

        } else {
            $('#old-pass').attr('type', 'text');
            $(this).html(`<i class="ki-duotone ki-eye-slash fs-3" id="icon-old-pass">
                                                                                           <span class="path1 ki-uniEC0B"></span>
                                                                                           <span class="path2 ki-uniEC0B"></span>
                                                                                           <span class="path3 ki-uniEC0D"></span>
                                                                                      </i>`);
        }

    });
    $('.btn_show_confirm_pass').on('click', function (e) {
        if ($('#confirm-pass').attr('type') == 'text') {
            $('#confirm-pass').attr('type', 'password');
            $(this).html(`<i class="ki-duotone ki-eye fs-3" id="icon-confirm-pass">
                                                                                           <span class="path1 ki-uniEC0B"></span>
                                                                                           <span class="path2 ki-uniEC0B"></span>
                                                                                           <span class="path3 ki-uniEC0D"></span>
                                                                                      </i>`);

        } else {
            $('#confirm-pass').attr('type', 'text');
            $(this).html(`<i class="ki-duotone ki-eye-slash fs-3" id="icon-confirm-pass">
                                                                                               <span class="path1 ki-uniEC0B"></span>
                                                                                               <span class="path2 ki-uniEC0B"></span>
                                                                                               <span class="path3 ki-uniEC0D"></span>
                                                                                          </i>`);
        }

    });
    $('.btn_show_new_pass').on('click', function (e) {
        if ($('#new-pass').attr('type') == 'text') {
            $('#new-pass').attr('type', 'password');
            $(this).html(`<i class="ki-duotone ki-eye fs-3" id="icon-new-pass">
                                                                                       <span class="path1 ki-uniEC0B"></span>
                                                                                       <span class="path2 ki-uniEC0B"></span>
                                                                                       <span class="path3 ki-uniEC0D"></span>
                                                                                  </i>`);

        } else {
            $('#new-pass').attr('type', 'text');
            $(this).html(`<i class="ki-duotone ki-eye-slash fs-3" id="icon-new-pass">
                                                                                           <span class="path1 ki-uniEC0B"></span>
                                                                                           <span class="path2 ki-uniEC0B"></span>
                                                                                           <span class="path3 ki-uniEC0D"></span>
                                                                                      </i>`);
        }

    });
    $(document).ready(function () {

        $('#view-password').click(function () {
            $('#kt_tab_pane_2').removeClass("d-none");
            $('#kt_tab_pane_1').addClass("d-none");
            currentView = 1;
        });
        $('#view-info').click(function () {
            $('#kt_tab_pane_2').addClass("d-none");
            $('#kt_tab_pane_1').removeClass("d-none");
            currentView = 0;
        });
        $('#view-notification').click(function () {
            $('#kt_tab_pane_1').addClass("d-none");
            $('#kt_tab_pane_2').addClass("d-none");
        });

        $('#view-history-kpi').click(function () {
            $('#kt_tab_pane_1').addClass("d-none");
            $('#kt_tab_pane_2').addClass("d-none");
        });
        GetInfoProfile();
    });
    function GetInfoProfile() {
        $.ajax({
            url: "@Url.Action("GetInfoAccountById","Account")",
            type: "GET",
            beforeSend: function (xhr) {
                if (localStorage.token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token);
                }
            },
            success: function (response) {
                if (response.status == 200) {
                    var infoProfile = response.resources;
                    $("#full-name").val(infoProfile.fullName);
                    $("#full-name-login").text(infoProfile.fullName);
                    $("#user-name").text(infoProfile.username);
                    $("#role-name").text(infoProfile.roleName);
                    $("#role-name-login").text(infoProfile.roleName);
                }
            },
            error: function (request, status, error) {
                //console.error(error);
            },
        });
    }
    function ValidateData() {
        var listError = [];
        if (currentView == 0) {
            if ($("#full-name").val().length == 0) {
                listError.push("Họ và tên không được để trống");
            }
            if ($("#full-name").val().length > 255) {
                listError.push("Họ và tên không được nhiều hơn 255 kí tự");
            }
        }
        else {
            if ($("#old-pass").val().length < 6) {
                listError.push("Độ dài Mật khẩu hiện tại không được nhỏ hơn 6");
            }
            if ($("#old-pass").val().length > 255) {
                listError.push("Mật khẩu hiện tại không được nhiều hơn 255 kí tự");
            }
            if ($("#new-pass").val().length < 6) {
                listError.push("Độ dài Mật khẩu mới không được nhỏ hơn 6");
            }
            if ($("#new-pass").val().length > 255) {
                listError.push("Mật khẩu mới không được nhiều hơn 255 kí tự");
            }
            if ($("#confirm-pass").val().length < 6) {
                listError.push("Độ dài xác nhận lại mật khẩu không được nhỏ hơn 6");
            }
            if ($("#confirm-pass").val().length > 255) {
                listError.push("Nhập lại mật khẩu mới không được nhiều hơn 255 kí tự");
            }
            if ($("#new-pass").val() != $("#confirm-pass").val()) {
                listError.push("Mật khẩu mới và Nhập lại mật khẩu mới không giống nhau ");
            }
        }
        if (listError.length > 0) {
            contentError = "<ul>";
            listError.forEach(function (item, index) {
                contentError += "<li class='text-start'>" + item + "</li>";
            })
            contentError += "</ul>";
            Swal.fire(
                "Cập nhật không thành công",
                contentError,
                "warning"
            );

        }
        else {
            if (currentView == 0) {
                UpdateProfile();
            }
            else {
                UpdateProfile();
            }
        }
    }

    function UpdateProfile() {
        var objInfo = {
            "fullName": $("#full-name").val(),
            "userName": $("#user-name").text(),
            "roleName": $("#role-name").text(),
        };
        var objPassword = {
            "newPassword": $("#new-pass").val(),
            "oldPassword": $("#old-pass").val(),
            "confirm": $("#confirm-pass").val(),
        };
        Swal.fire({
            title: 'Xác nhận thay đổi?',
            text: 'Thay đổi thông tin cá nhân',
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#443',
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Huỷ'
        }).then((result) => {
            if (result.value) {
                if (currentView == 0) {
                    $.ajax({
                        url: "@Url.Action("UpdateFullNameById", "Account")",
                        type: "PUT",
                        contentType: "application/json",
                        beforeSend: function (xhr) {
                            if (localStorage.token) {
                                xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token);
                            }
                        },
                        data: JSON.stringify(objInfo),
                        success: function (responseData) {
                            if (responseData.status == 200 && responseData.message === "SUCCESS") {
                                Swal.fire(
                                    'Thành Công!',
                                    'Đã cập nhật thông tin cá nhân',
                                    'success'
                                );
                                $(".full-name").text($("#full-name").val());
                                $("#full-name-login").text($("#full-name").val());
                            }
                        },
                        error: function (e) {
                            Swal.fire(
                                'Lỗi!',
                                'Đã xảy ra lỗi, vui lòng thử lại',
                                'error'
                            );
                        }
                    });
                }
                else {
                    $.ajax({
                        url: "@Url.Action("UpdatePasswordById", "Account")",
                        type: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify(objPassword),
                        success: function (responseData) {
                            if (responseData.status == 200 && responseData.message === "SUCCESS") {
                                Swal.fire(
                                    'Thành Công!',
                                    'Đã cập nhật mật khẩu',
                                    'success'
                                );
                            }
                        },
                        error: function (e) {
                            Swal.fire(
                                'Lỗi!',
                                'Đã xảy ra lỗi, vui lòng thử lại',
                                'error'
                            );
                        }
                    });
                }
            }
        })
    }
</script>


